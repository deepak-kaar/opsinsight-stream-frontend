<div class="pt-[50px] pl-[20px] pr-[20px] w-full">
    <div class="flex justify-end pb-[10px]">
        <p-button routerLink="/datapointAdmin/home/flags" label="Back" />
    </div>
    <p-card class="w-full">
        <p-stepper [(value)]="activeStep" class="basis-[40rem]">
            <p-step-list>
                <p-step [value]="1">Add Flag</p-step>
                <p-step [value]="2">Input Variables</p-step>
                <p-step [value]="3">Expression Creation</p-step>
                <!-- <p-step [value]="4">Map Severity</p-step> -->
            </p-step-list>
            <p-step-panels>
                <p-step-panel [value]="1">
                    <ng-template #content let-activateCallback="activateCallback">
                        <form [formGroup]="flagForm">
                            <div class="flex flex-col align-items-center justify-content-center flex-wrap gap-4">
                                <div class="flex w-full h-full align-items-start gap-[10px]">
                                    <div class="flex w-full flex-col">
                                        <label for="flagname">Flag Name</label>
                                        <input id="flagname" type="text" pInputText formControlName="flagName"
                                            [style]="{ width: '100%', height: '100%' }" />

                                        @if(flagForm.get('flagName')?.invalid &&
                                        flagForm.get('flagName')?.touched){
                                        <small class="p-error pl-2"> Flag Name is required. </small>
                                        }
                                    </div>
                                </div>
                                <div class="flex w-full flex-3 flex-col">
                                    <label for="flag-description">Flag Description</label>
                                    <textarea id="flag-description" rows="4" formControlName="description" cols="20"
                                        [autoResize]="false" pTextarea [style]="{
                                        width: '100%',
                                        height: '100%'
                                      }">
                                    </textarea>

                                    @if(flagForm.get('description')?.invalid &&
                                    flagForm.get('description')?.touched){
                                    <small class="p-error pl-2">
                                        Flag Description is required.
                                    </small>
                                    }
                                </div>
                            </div>
                        </form>
                        <div class="flex pt-6 justify-end">
                            <p-button (onClick)="activateCallback(2)" label="Next" icon="pi pi-arrow-right"
                                iconPos="right" />
                        </div>
                    </ng-template>
                </p-step-panel>

                <p-step-panel [value]="2">
                    <ng-template #content let-activateCallback="activateCallback">
                        {{flagForm.get('flagName')?.value}}
                        <form [formGroup]="variableForm">
                            <div>
                                <div class="surface-border border-bottom-2 p-1 flex content-end justify-end">
                                    <p-button label="Add Variable" icon="pi pi-plus" outlined="true"
                                        (onClick)="onAddVariable()" />
                                </div>
                                <div formArrayName="variables">
                                    @for(variable of variables.controls;track variable;let idx =
                                    $index){

                                    <div class="w-full flex gap-4 card items-center pt-10 flex-wrap"
                                        [formGroupName]="idx">
                                        <div class="flex-1">
                                            <div class="w-full">
                                                <label for="variableName">Variable Name</label>
                                                <input id="variableName" type="text" pInputText style='width:100%'
                                                    formControlName="variableName"
                                                    (change)="checkDuplicateVariableName(idx)" />

                                                @if(isDuplicateError[idx]){
                                                <small class="p-error pl-2">
                                                    Variable Name already exists.
                                                </small>
                                                } @else if(variable.get('variableName')?.invalid &&
                                                variable.get('variableName')?.touched){
                                                <small class="p-error pl-2">
                                                    Variable Name is required.</small>
                                                }
                                            </div>
                                        </div>
                                        <div class="pt-4">
                                            <p-button icon="pi pi-trash" [rounded]="true" [text]="true" [raised]="true"
                                                [style]="{ color: '#F97316', background: '#FFEADC' }"
                                                (onClick)="onRemoveVaribale(idx)" />
                                        </div>
                                    </div>
                                    }
                                </div>
                            </div>
                        </form>
                        <div class="flex pt-6 justify-between">
                            <p-button (onClick)="activateCallback(1)" label="Back" severity="secondary"
                                icon="pi pi-arrow-left" />
                            <p-button (onClick)="activateCallback(3)" label="Next" icon="pi pi-arrow-right"
                                iconPos="right" />
                        </div>
                    </ng-template>
                </p-step-panel>

                <p-step-panel [value]="3">
                    <ng-template #content let-activateCallback="activateCallback">
                        <form [formGroup]="expressionsForm">
                            <div>
                                <div class="surface-border border-bottom-2 p-3 flex content-end justify-start mb-2">
                                    <span>Total Expressions Created -
                                        {{ expressions.controls.length }}</span>
                                </div>
                                <div formArrayName="expressions">
                                    @for(expression of expressions.controls;track expression;let idx =
                                    $index){
                                    <div class="card surface-border border-round" [formGroupName]="idx">
                                        <p-panel [header]="'Expression - ' + (idx + 1)" [toggleable]="true" [collapsed]="
                                          expressions.controls.length !== idx + 1 ? true : false
                                        " [collapseIcon]="'pi pi-chevron-up'" [expandIcon]="'pi pi-chevron-down'">
                                            <ng-template #header>
                                                <div class="flex items-center gap-2">
                                                    <div class="flex w-full items-center gap-3">
                                                        <label for="flagname">Flag Severity</label>
                                                        <p-select [options]="flagSeverity" optionLabel="name"
                                                            formControlName="severity" [style]="{'width':'200px'}" />
                                                    </div>
                                                </div>
                                            </ng-template>
                                            <div class="card flex justify-center">
                                                <p-selectbutton [options]="expressionOpt" formControlName="editorType"
                                                    aria-labelledby="basic" />
                                            </div>
                                            @if(expression.get('editorType')?.value === 'Flow Editor')
                                            {
                                            <div formArrayName="conditions" class="pt-4 pb-4">
                                                @for(condition of conditions(idx).controls;track
                                                condition;let j = $index){
                                                <div class="flex flex-col h-full w-full" [formGroupName]="j">
                                                    <div class="grid grid-cols-4 gap-4 items-center flex-wrap">
                                                        <div class="col">
                                                            <div class="flex flex-col">
                                                                <label for="variableName" class="pl-2">Value Type
                                                                </label>
                                                                <p-select [options]="values"
                                                                    formControlName="leftValueType"
                                                                    [style]="{ width: '200px' }" />
                                                                @if(condition.get('leftValueType')?.invalid
                                                                && condition.get('leftValueType')?.touched){
                                                                <small class="p-error pl-2">
                                                                    Value Type is required. </small>
                                                                }
                                                            </div>
                                                        </div>
                                                        <div class="col">
                                                            @if(condition.get('leftValueType')?.value === 'Constant'
                                                            ){
                                                            <div class="flex flex-col">
                                                                <label for="variableName" class="pl-2">Value</label>
                                                                <input id="variableName" type="text" pInputText
                                                                    [style]="{ width: '200px'}"
                                                                    formControlName="leftAssignmentVariable" />
                                                                @if(condition.get('leftAssignmentVariable')?.invalid
                                                                && condition.get('leftAssignmentVariable')?.touched){
                                                                <small class="p-error pl-2">
                                                                    Value is required. </small>
                                                                }
                                                            </div>
                                                            }
                                                            @else if(condition.get('leftValueType')?.value ===
                                                            'Variables')
                                                            {
                                                            <div class="flex flex-col items-start justify-center">
                                                                <label for="variableName" class="pl-2">Select
                                                                    Variable</label><p-select
                                                                    [options]="variables.value"
                                                                    optionLabel="variableName"
                                                                    formControlName="leftAssignmentVariable"
                                                                    [style]="{ width: '200px' }" />
                                                                @if(condition.get('leftAssignmentVariable')?.invalid
                                                                &&
                                                                condition.get('leftAssignmentVariable')?.touched){
                                                                <small class="p-error pl-2">
                                                                    Variable is required. </small>}
                                                            </div>
                                                            }
                                                            @else if(condition.get('leftValueType')?.value ===
                                                            'Expression')
                                                            {
                                                            <div class="flex flex-col">
                                                                <label for="variableName"
                                                                    class="pl-2">Expression</label>
                                                                <input id="variableName" type="text" pInputText
                                                                    [style]="{ width: '200px'}"
                                                                    formControlName="leftAssignmentVariable" />
                                                                @if(condition.get('leftAssignmentVariable')?.invalid
                                                                && condition.get('leftAssignmentVariable')?.touched){
                                                                <small class="p-error pl-2">
                                                                    Expression is required. </small>
                                                                }
                                                            </div>
                                                            }
                                                        </div>
                                                        <div class="col">
                                                            <div class="flex flex-col items-start justify-center">
                                                                <label for="operator" class="pl-2">Select
                                                                    Operator</label>
                                                                <p-select [options]="operators" optionLabel="name"
                                                                    formControlName="operator"
                                                                    [style]="{ width: '200px' }" />

                                                                @if(condition.get('operator')?.invalid &&
                                                                condition.get('operator')?.touched){
                                                                <small class="p-error pl-2">
                                                                    Operator is required. </small>}
                                                            </div>
                                                        </div>
                                                        <div class="col">
                                                            <div class="flex flex-col">
                                                                <label for="variableName" class="pl-2">Value Type
                                                                </label>
                                                                <p-select [options]="values"
                                                                    formControlName="rightValueType"
                                                                    [style]="{ width: '200px' }" />
                                                                @if(condition.get('rightValueType')?.invalid
                                                                && condition.get('rightValueType')?.touched){
                                                                <small class="p-error pl-2">
                                                                    Value Type is required. </small>
                                                                }
                                                            </div>
                                                        </div>
                                                        <div class="col">
                                                            @if(condition.get('rightValueType')?.value === 'Constant'
                                                            ){
                                                            <div class="flex flex-col">
                                                                <label for="variableName" class="pl-2">Value</label>
                                                                <input id="variableName" type="text" pInputText
                                                                    [style]="{ width: '200px'}"
                                                                    formControlName="rightAssignmentValue" />
                                                                @if(condition.get('rightAssignmentValue')?.invalid
                                                                && condition.get('rightAssignmentValue')?.touched){
                                                                <small class="p-error pl-2">
                                                                    Value is required. </small>
                                                                }
                                                            </div>
                                                            }
                                                            @else if(condition.get('rightValueType')?.value ===
                                                            'Variables')
                                                            {
                                                            <div class="flex flex-col items-start justify-center">
                                                                <label for="variableName" class="pl-2">Select
                                                                    Variable</label><p-select
                                                                    [options]="variables.value"
                                                                    optionLabel="variableName"
                                                                    formControlName="rightAssignmentValue"
                                                                    [style]="{ width: '200px' }" />
                                                                @if(condition.get('leftAssignmentVariable')?.invalid
                                                                &&
                                                                condition.get('rightAssignmentValue')?.touched){
                                                                <small class="p-error pl-2">
                                                                    Variable is required. </small>}
                                                            </div>
                                                            }
                                                            @else if(condition.get('rightValueType')?.value ===
                                                            'Expression')
                                                            {
                                                            <div class="flex flex-col">
                                                                <label for="variableName"
                                                                    class="pl-2">Expression</label>
                                                                <input id="variableName" type="text" pInputText
                                                                    [style]="{ width: '200px'}"
                                                                    formControlName="rightAssignmentValue" />
                                                                @if(condition.get('rightAssignmentValue')?.invalid
                                                                && condition.get('rightAssignmentValue')?.touched){
                                                                <small class="p-error pl-2">
                                                                    Expression is required. </small>
                                                                }
                                                            </div>
                                                            }
                                                        </div>
                                                        <div class="col pt-4">
                                                            <div class="flex gap-2">
                                                                @if(j===conditions(idx).controls.length-1){
                                                                <p-button icon="pi pi-plus" [rounded]="true"
                                                                    [text]="true" [raised]="true" [style]="{
                                                      color: '#00A3E0',
                                                      background: '#F0FBFF',
                                        
                                                    }" (onClick)="addCondition(idx)" />

                                                                @if(j>0){
                                                                <p-button [rounded]="true" [style]="{
                                                      color: '#00A3E0',
                                                      background: '#F0FBFF'
                                                    }" [outlined]="false" [raised]="true" [text]="true"
                                                                    icon="pi pi-minus"
                                                                    (onClick)="removeCondition(idx, j)" />
                                                                } }
                                                            </div>
                                                        </div>
                                                    </div>


                                                    @if(j!==conditions(idx).controls.length-1){
                                                    <div class="flex flex-wrap pt-2 pb-2 items-center justify-start">
                                                        <p-selectButton [options]="stateOptions" optionLabel="label"
                                                            optionValue="value" formControlName="conditionOperator"
                                                            [style]="{
                                                  width: 'auto',
                                                  minWidth: '100px',
                                                  height: '40px',
                                                  'font-size': '11px'
                                                }" />
                                                    </div>
                                                    }
                                                </div>

                                                }
                                            </div>
                                            } @else if (expression.get('editorType')?.value === 'Code Editor') {
                                            <div class="h-[10rem] pt-4 pb-4">
                                                <ngx-monaco-editor style="width:100%; height: 100%"
                                                    [options]="editorOptions"
                                                    formControlName="code"></ngx-monaco-editor>
                                            </div>
                                            }
                                            <div class="flex flex-col">
                                                <label>Output Message</label>
                                                <input formControlName="outputMessage" pInputText class="w-full">
                                            </div>
                                        </p-panel>
                                        @if(idx===expressions.controls.length-1){
                                        <div class="flex p-3 surface-card surface-border">
                                            <div class="flex-1 flex items-center justify-start">
                                                <p-button class="mr-3" icon="pi pi-plus" [rounded]="true"
                                                    [outlined]="true"
                                                    [style]="{ background: 'var(--p-primary-color)', color: '#FFFFFF' }"
                                                    label="Add new condition" (onClick)="addExpression()" />
                                                <label for="newCondition">Create new condition</label>
                                            </div>
                                            <div class="flex-1 flex items-center justify-end">
                                                <!-- <p-selectButton [options]="stateOptions" optionLabel="label"
                                                    optionValue="value" formControlName="expressionOperator" [style]="{
                                              width: 'auto',
                                              minWidth: '100px',
                                              height: '40px',
                                            }" /> -->
                                                @if (idx>0) {
                                                <p-button icon="pi pi-trash" [rounded]="true" [text]="true"
                                                    class="flex ml-4" [raised]="true" [style]="{
                                              color: '#F97316',
                                              background: '#FFEADC'
                                            }" (onClick)="removeExpression(idx)" />
                                                }
                                            </div>
                                        </div>
                                        }
                                    </div>

                                    <div class="conditon-class flex surface-100 items-center justify-center">
                                        <!-- <svg width="108" height="70" viewBox="0 0 108 128" fill="none"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path d="M50.4998 86.7495L50.5004 127.407M50.5 -0.000199901L50.5005 40.6569"
                                                stroke="var(--p-primary-color)" stroke-width="2" />
                                            <rect width="108" height="51.7753" transform="translate(0 38.2153)"
                                                fill="none" />
                                            <g clip-path="url(#clip0_666_19657)">
                                                <path
                                                    d="M41.5 64.103C41.5 65.2897 41.1481 66.4498 40.4888 67.4364C39.8295 68.4231 38.8925 69.1922 37.7961 69.6463C36.6997 70.1004 35.4933 70.2192 34.3295 69.9877C33.1656 69.7562 32.0965 69.1848 31.2574 68.3457C30.4182 67.5065 29.8468 66.4375 29.6153 65.2736C29.3838 64.1097 29.5026 62.9033 29.9567 61.8069C30.4109 60.7106 31.1799 59.7735 32.1666 59.1142C33.1533 58.4549 34.3133 58.103 35.5 58.103C37.0913 58.103 38.6174 58.7352 39.7426 59.8604C40.8679 60.9856 41.5 62.5117 41.5 64.103Z"
                                                    fill="var(--p-primary-color)" />
                                                <path
                                                    d="M57.6826 60.0317L54.3877 69.103H53.041L56.835 59.1499H57.7031L57.6826 60.0317ZM60.4443 69.103L57.1426 60.0317L57.1221 59.1499H57.9902L61.7979 69.103H60.4443ZM60.2734 65.4185V66.4985H54.6816V65.4185H60.2734ZM70.7871 59.1499V69.103H69.4609L64.4502 61.4263V69.103H63.1309V59.1499H64.4502L69.4814 66.8472V59.1499H70.7871ZM75.8184 69.103H73.7402L73.7539 68.0298H75.8184C76.5293 68.0298 77.1217 67.8817 77.5957 67.5854C78.0697 67.2847 78.4251 66.8654 78.6621 66.3276C78.9036 65.7853 79.0244 65.1519 79.0244 64.4272V63.8188C79.0244 63.2492 78.9561 62.7433 78.8193 62.3013C78.6826 61.8547 78.4821 61.4787 78.2178 61.1733C77.9535 60.8634 77.6299 60.6287 77.2471 60.4692C76.8688 60.3097 76.4336 60.23 75.9414 60.23H73.6992V59.1499H75.9414C76.5931 59.1499 77.1878 59.2593 77.7256 59.478C78.2633 59.6922 78.7259 60.0044 79.1133 60.4146C79.5052 60.8201 79.806 61.3123 80.0156 61.8911C80.2253 62.4653 80.3301 63.1125 80.3301 63.8325V64.4272C80.3301 65.1473 80.2253 65.7967 80.0156 66.3755C79.806 66.9497 79.5029 67.4396 79.1064 67.8452C78.7145 68.2508 78.2406 68.563 77.6846 68.7817C77.1331 68.9959 76.5111 69.103 75.8184 69.103ZM74.4443 59.1499V69.103H73.125V59.1499H74.4443Z"
                                                    fill="var(--p-primary-color)" />
                                            </g>
                                            <path
                                                d="M1 43.2153H86.1124C97.6483 43.2153 107 52.567 107 64.103C107 75.6389 97.6483 84.9906 86.1124 84.9906H1V43.2153Z"
                                                stroke="var(--p-primary-color)" stroke-width="2" />
                                            <defs>
                                                <clipPath id="clip0_666_19657">
                                                    <path
                                                        d="M0 42.2153H86.1124C98.2006 42.2153 108 52.0148 108 64.103V64.103C108 76.1912 98.2006 85.9906 86.1124 85.9906H0V42.2153Z"
                                                        fill="var(--p-primary-color)" />
                                                </clipPath>
                                            </defs>
                                        </svg> -->

                                        <svg width="108" height="70" viewBox="0 0 108 128" fill="none"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path d="M50.4998 86.7495L50.5004 127.407M50.5 -0.000199901L50.5005 40.6569"
                                                stroke="var(--p-primary-color)" stroke-width="2" />
                                            <rect width="108" height="51.7753" transform="translate(0 38.2153)"
                                                fill="none" />
                                            <g clip-path="url(#clip0_666_19657)">
                                                <path
                                                    d="M41.5 64.103C41.5 65.2897 41.1481 66.4498 40.4888 67.4364C39.8295 68.4231 38.8925 69.1922 37.7961 69.6463C36.6997 70.1004 35.4933 70.2192 34.3295 69.9877C33.1656 69.7562 32.0965 69.1848 31.2574 68.3457C30.4182 67.5065 29.8468 66.4375 29.6153 65.2736C29.3838 64.1097 29.5026 62.9033 29.9567 61.8069C30.4109 60.7106 31.1799 59.7735 32.1666 59.1142C33.1533 58.4549 34.3133 58.103 35.5 58.103C37.0913 58.103 38.6174 58.7352 39.7426 59.8604C40.8679 60.9856 41.5 62.5117 41.5 64.103Z"
                                                    fill="var(--p-primary-color)" />
                                                <text x="48" y="68" font-size="12" font-family="Arial, sans-serif"
                                                    fill="var(--p-primary-color)">ELSE IF</text>
                                            </g>
                                            <path
                                                d="M1 43.2153H86.1124C97.6483 43.2153 107 52.567 107 64.103C107 75.6389 97.6483 84.9906 86.1124 84.9906H1V43.2153Z"
                                                stroke="var(--p-primary-color)" stroke-width="2" />
                                            <defs>
                                                <clipPath id="clip0_666_19657">
                                                    <path
                                                        d="M0 42.2153H86.1124C98.2006 42.2153 108 52.0148 108 64.103V64.103C108 76.1912 98.2006 85.9906 86.1124 85.9906H0V42.2153Z"
                                                        fill="var(--p-primary-color)" />
                                                </clipPath>
                                            </defs>
                                        </svg>
                                    </div>
                                    }
                                </div>
                            </div>
                        </form>


                        <div class="flex pt-6 justify-between">
                            <p-button (onClick)="activateCallback(2)" label="Back" severity="secondary"
                                icon="pi pi-arrow-left" />
                            <p-button (onClick)="onSaveFlag()" label="save" icon="pi pi-save" iconPos="left" />
                        </div>
                    </ng-template>
                </p-step-panel>
            </p-step-panels>
        </p-stepper>
    </p-card>

    <p-toast />
</div>